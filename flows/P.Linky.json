[
  {
    "id": "a1e22fa468f03c15",
    "type": "tab",
    "label": "P.Linky",
    "disabled": false,
    "info": "",
    "env": []
  },
  {
    "id": "3df91d363faee835",
    "type": "group",
    "z": "a1e22fa468f03c15",
    "name": "linky - bucket",
    "style": {
      "fill": "#ffC000",
      "fill-opacity": "0.05",
      "label": true,
      "stroke": "#ffC000"
    },
    "nodes": [
      "3325e4593048135a",
      "05787fb2b77146c8",
      "0ad08e9e45d5435d"
    ],
    "x": 94,
    "y": 19,
    "w": 342,
    "h": 82
  },
  {
    "id": "f7b8f0b4a2f0c6c9",
    "type": "group",
    "z": "a1e22fa468f03c15",
    "name": "linky to influxdb",
    "style": {
      "fill": "#777777",
      "fill-opacity": "0.05",
      "label": true
    },
    "nodes": [
      "f65dfdda10900ffc",
      "b0150193e3cce710",
      "543a74289e049295",
      "213d292b79e5fbcc",
      "d0f7ea2cfc4571a3"
    ],
    "x": 68,
    "y": 413,
    "w": 1574,
    "h": 2174
  },
  {
    "id": "9817cea0e8546fbb",
    "type": "group",
    "z": "a1e22fa468f03c15",
    "name": "linky - config",
    "style": {
      "fill": "#777777",
      "fill-opacity": "0.05",
      "label": true
    },
    "nodes": [
      "9cd020968fe2a19d",
      "2cdbc171bc86cb06"
    ],
    "x": 68,
    "y": 2625.5,
    "w": 1714,
    "h": 321.5
  },
  {
    "id": "14bfb846eebf04b4",
    "type": "group",
    "z": "a1e22fa468f03c15",
    "name": "linky - scene - current to offloading",
    "style": {
      "fill": "#92d04f",
      "fill-opacity": "0.1",
      "label": true
    },
    "nodes": [
      "8a93715d93e96ec9",
      "ab2015a7036a8a2d",
      "d5fc9c7840e287c6",
      "4d9eef91906c3f6b",
      "5ac5e9a27184058b",
      "71d2809882564006",
      "b497d6eeef074cdf",
      "a97c1309cdf39d94",
      "c34352d41e16989c",
      "4638c42f2e097580",
      "bcab76bcab7be22c",
      "2aaa6917be59ea44"
    ],
    "x": 94,
    "y": 3559,
    "w": 1822,
    "h": 142
  },
  {
    "id": "8a97ad21fb974dbd",
    "type": "group",
    "z": "a1e22fa468f03c15",
    "name": "catch error",
    "style": {
      "fill": "#ff0000",
      "fill-opacity": "0.05",
      "label": true,
      "stroke": "#ff0000"
    },
    "nodes": [
      "6f11b20b69a42029",
      "31fc5fdc93b7363d",
      "d7b616f51fec6d9a"
    ],
    "x": 534,
    "y": 19,
    "w": 422,
    "h": 82
  },
  {
    "id": "b9a706d9e4980c1e",
    "type": "group",
    "z": "a1e22fa468f03c15",
    "name": "mqtt server for teleinfo",
    "style": {
      "fill": "#ffffff",
      "fill-opacity": "0.5",
      "label": true,
      "stroke": "#0070c0"
    },
    "nodes": [
      "fee31a77e542b203",
      "0bf16a20b9656c59"
    ],
    "x": 68,
    "y": 173,
    "w": 1824,
    "h": 194
  },
  {
    "id": "b31845e35ff96b51",
    "type": "group",
    "z": "a1e22fa468f03c15",
    "name": "home - linky",
    "style": {
      "fill": "#777777",
      "fill-opacity": "0.05",
      "label": true
    },
    "nodes": [
      "f36ad9add0dea84a",
      "4cb9d5d99960728b",
      "afbdaa08d5344ac6"
    ],
    "x": 68,
    "y": 2993,
    "w": 3504,
    "h": 494
  },
  {
    "id": "f65dfdda10900ffc",
    "type": "group",
    "z": "a1e22fa468f03c15",
    "g": "f7b8f0b4a2f0c6c9",
    "name": "lecture teleinfo",
    "style": {
      "label": true,
      "fill": "#ff0000",
      "fill-opacity": "0.05"
    },
    "nodes": [
      "8546ac1e37b1b1fc",
      "1ef3db77515c5330",
      "df67aa8c4eb08c4b",
      "6b5f520afcf9e941",
      "1c6a5f6cf7a4171a",
      "e3ec96cdb6ecec1d",
      "2235915bcd1a9228",
      "df89dd445c170c34",
      "539176543f03340e",
      "528d193f3ad76c04",
      "d259cbfd50910254",
      "4f66f48da30fbb41",
      "5543b63f4f841d35",
      "16e115607aca11e2",
      "573b86bbb0b274cd",
      "6969a430e98620f8",
      "c40a25fa809f3f3f",
      "cad9f0d374763a50",
      "9846cd104deb4095",
      "80713009a92b1fb1",
      "25b8f66cb5486055",
      "25a206dee6cb2d38",
      "10352a4c8044bff8",
      "d1f398881a976c8c",
      "06b7f0862564450a"
    ],
    "x": 94,
    "y": 439,
    "w": 1192,
    "h": 502
  },
  {
    "id": "b0150193e3cce710",
    "type": "group",
    "z": "a1e22fa468f03c15",
    "g": "f7b8f0b4a2f0c6c9",
    "name": "ecriture influxdb",
    "style": {
      "label": true,
      "fill": "#ff0000",
      "fill-opacity": "0.05"
    },
    "nodes": [
      "c2bbb4adbb91e2eb",
      "e340056f7c0ff7e6",
      "4f2f651b305df0d8",
      "f8e8e4320c84ad84",
      "b20175d86ac76169"
    ],
    "x": 94,
    "y": 2359,
    "w": 492,
    "h": 202
  },
  {
    "id": "543a74289e049295",
    "type": "group",
    "z": "a1e22fa468f03c15",
    "g": "f7b8f0b4a2f0c6c9",
    "name": "calcul pinst",
    "style": {
      "label": true,
      "fill": "#ff0000",
      "fill-opacity": "0.05"
    },
    "nodes": [
      "2c63586ece8ae18a",
      "543a55099b4d2327",
      "06e4c17b8ac467e1",
      "af3687a9f899e8da",
      "9a0856ef24c6ecb1",
      "905240083e6bd5a2",
      "e57340f8784de737",
      "1d84aac6c8e2a838",
      "eaf239f4e4fd9d20",
      "9a0a261261c064da",
      "ffd6cc9a833578f9",
      "fd73f58e64fd7772"
    ],
    "x": 94,
    "y": 979,
    "w": 1522,
    "h": 142
  },
  {
    "id": "213d292b79e5fbcc",
    "type": "group",
    "z": "a1e22fa468f03c15",
    "g": "f7b8f0b4a2f0c6c9",
    "name": "Set l'index de chaque période à l'index courant au début de période",
    "style": {
      "label": true,
      "fill": "#ff0000",
      "fill-opacity": "0.05"
    },
    "nodes": [
      "c84ad49be11b1bd9",
      "1cde90641d601c65",
      "78a8877be3e75897",
      "2b15984780ad93da",
      "7e164b153068131f",
      "cdfbaf7f971088a0",
      "c77835080e9f86f2",
      "aaa4d5f3593d6d65",
      "f897b93a09482883",
      "6430485715d1b2a6",
      "8c5505de0a4d3dcd",
      "5b6872ce327b1bf3",
      "1cde90641d601c65"
    ],
    "x": 94,
    "y": 1159,
    "w": 892,
    "h": 562
  },
  {
    "id": "d0f7ea2cfc4571a3",
    "type": "group",
    "z": "a1e22fa468f03c15",
    "g": "f7b8f0b4a2f0c6c9",
    "name": "Compte le nombre d'indexes passé depuis le début de chaque période (toutes les minutes)",
    "style": {
      "label": true,
      "fill": "#ff0000",
      "fill-opacity": "0.05"
    },
    "nodes": [
      "82ef8057da8c77aa",
      "6c25a04857d1716e",
      "f2de43c0a6cb7bf1",
      "9a2254b818f75188",
      "86b0a6aba2f70fe6",
      "9bc81eccbc500c73",
      "997f6535a7397b5d",
      "c548f2f0529f2243",
      "b4e36b962e02a910",
      "38fbbacd76a1ebc8",
      "bcd49af0e6417d46",
      "7a20b1c05a7278f5"
    ],
    "x": 94,
    "y": 1759,
    "w": 802,
    "h": 562
  },
  {
    "id": "9cd020968fe2a19d",
    "type": "group",
    "z": "a1e22fa468f03c15",
    "g": "9817cea0e8546fbb",
    "name": "linky - config - device",
    "style": {
      "fill": "#ffC000",
      "fill-opacity": "0.05",
      "label": true
    },
    "nodes": [
      "96d8b83164d22086",
      "2a688b0630f5cca4",
      "60a457c83fc5f610",
      "b52eeb9d79637d39",
      "5f80823cb39801f0",
      "33c0603ad410d85c"
    ],
    "x": 94,
    "y": 2659,
    "w": 622,
    "h": 202
  },
  {
    "id": "2cdbc171bc86cb06",
    "type": "group",
    "z": "a1e22fa468f03c15",
    "g": "9817cea0e8546fbb",
    "name": "linky - config - ui",
    "style": {
      "fill": "#6f2fa0",
      "fill-opacity": "0.05",
      "label": true
    },
    "nodes": [
      "7e386532c9061f5e",
      "778b0602db797687",
      "876d9a75aa665dc1",
      "9a7fb4052f4efa9d",
      "7472a7716d5e79fb",
      "7a340e512e7cec9a",
      "6ed80a0ca731e211",
      "3c6f3e3cd994cec9",
      "18fc113bdb7e4440",
      "d997a0effd6d0126",
      "7162b7919ee04e41",
      "b8a1f342f4e14446"
    ],
    "x": 814,
    "y": 2651.5,
    "w": 942,
    "h": 269.5
  },
  {
    "id": "fee31a77e542b203",
    "type": "group",
    "z": "a1e22fa468f03c15",
    "g": "b9a706d9e4980c1e",
    "name": "devices teleinfo",
    "style": {
      "fill": "#0070c0",
      "fill-opacity": "0.05",
      "label": true
    },
    "nodes": [
      "c16f1ae420f44fb5",
      "b491f7eb02575108",
      "ca7f0d58c55a1358",
      "3423fd727184042c",
      "fa2acb5ac9bb8c8c",
      "a34aeb4c51bcf655"
    ],
    "x": 94,
    "y": 199,
    "w": 1162,
    "h": 142
  },
  {
    "id": "0bf16a20b9656c59",
    "type": "group",
    "z": "a1e22fa468f03c15",
    "g": "b9a706d9e4980c1e",
    "name": "",
    "style": {
      "fill": "#0070c0",
      "fill-opacity": "0.05",
      "label": true
    },
    "nodes": [
      "b0b2d9829230be99",
      "5d53068f8b9e6936",
      "a7e18f888c96ad05",
      "7a6db5a28141b284"
    ],
    "x": 1354,
    "y": 199,
    "w": 512,
    "h": 142
  },
  {
    "id": "f36ad9add0dea84a",
    "type": "group",
    "z": "a1e22fa468f03c15",
    "g": "b31845e35ff96b51",
    "name": "home - linky - source",
    "style": {
      "fill": "#0070c0",
      "fill-opacity": "0.05",
      "label": true
    },
    "nodes": [
      "9a7347381e1e503b",
      "cb99733f4cbf651a",
      "d16064888745aca6",
      "4f797f5a02d9c87b",
      "14633267d792195b",
      "0883ad76e9a7a5db",
      "a475141eb65765c3",
      "d90ff6b37443ec5f",
      "8e9b1543c286b201",
      "6d6ed9fb73d6e770",
      "d8cbcb0859722902",
      "0dac7d543eb0f2f6",
      "4587eb595b780266",
      "1f088dee7d4ae695",
      "43c18e1bfd41d830",
      "acc79920bf40652d",
      "8632c99c540f117b"
    ],
    "x": 754,
    "y": 3019,
    "w": 1242,
    "h": 442
  },
  {
    "id": "4cb9d5d99960728b",
    "type": "group",
    "z": "a1e22fa468f03c15",
    "g": "b31845e35ff96b51",
    "name": "home - linky - device",
    "style": {
      "fill": "#ffC000",
      "fill-opacity": "0.05",
      "label": true
    },
    "nodes": [
      "0e2bb377d8a36c19",
      "c726ae1ce799b0e5",
      "5efcbb548a75c53a",
      "6bb288d4243c8284",
      "614269acaeaa7867",
      "627ed76685724eb3",
      "f87443fe4174e06e",
      "ab6d3d1be0d9ea74"
    ],
    "x": 94,
    "y": 3019,
    "w": 562,
    "h": 382
  },
  {
    "id": "afbdaa08d5344ac6",
    "type": "group",
    "z": "a1e22fa468f03c15",
    "g": "b31845e35ff96b51",
    "name": "home - linky - ui",
    "style": {
      "fill": "#6f2fa0",
      "fill-opacity": "0.05",
      "label": true
    },
    "nodes": [
      "be031b830d435b36",
      "b0f5b19866b880c9",
      "14d401bc50aa536b",
      "9188974904e49bd8",
      "35ccd1812072ccad",
      "c3473ac9ec464425",
      "16de923274d0e608",
      "b5e38130b6f4407c",
      "b061fecd100938a0",
      "a5bcb16d923c6f77",
      "5d277429bd835728",
      "942e30b09b200628",
      "5d9abb5beb266ad0",
      "b9abd7ec5b21a355",
      "6c30e4c5efef2336",
      "04c4726b012f7cde",
      "b8039538d3ab41e7",
      "a5b6191ffdceb78b",
      "9e040dfa6ba0238f",
      "8883fe1a066abc69",
      "8e4e7eeb105a289a",
      "426522c68084a014"
    ],
    "x": 2174,
    "y": 3019,
    "w": 1372,
    "h": 322
  },
  {
    "id": "3325e4593048135a",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "3df91d363faee835",
    "name": "bucket",
    "rules": [
      {
        "t": "set",
        "p": "bucket",
        "pt": "msg",
        "to": "linky",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "bucket",
        "pt": "flow",
        "to": "bucket",
        "tot": "msg"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 270,
    "y": 60,
    "wires": [
      [
        "0ad08e9e45d5435d"
      ]
    ]
  },
  {
    "id": "05787fb2b77146c8",
    "type": "link in",
    "z": "a1e22fa468f03c15",
    "g": "3df91d363faee835",
    "name": "linky - bucket",
    "links": [
      "25445f5a9b787a0a"
    ],
    "x": 135,
    "y": 60,
    "wires": [
      [
        "3325e4593048135a"
      ]
    ]
  },
  {
    "id": "0ad08e9e45d5435d",
    "type": "link out",
    "z": "a1e22fa468f03c15",
    "g": "3df91d363faee835",
    "name": "linky - bucket",
    "mode": "link",
    "links": [
      "60a457c83fc5f610",
      "f5c52506bf786402"
    ],
    "x": 395,
    "y": 60,
    "wires": []
  },
  {
    "id": "8546ac1e37b1b1fc",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "f65dfdda10900ffc",
    "name": "type",
    "rules": [
      {
        "t": "set",
        "p": "payload.IINST",
        "pt": "msg",
        "to": "$number(msg.payload.IINST.value)",
        "tot": "jsonata"
      },
      {
        "t": "set",
        "p": "payload.HCHC",
        "pt": "msg",
        "to": "$number(msg.payload.HCHC.value)",
        "tot": "jsonata"
      },
      {
        "t": "set",
        "p": "payload.HCHP",
        "pt": "msg",
        "to": "$number(msg.payload.HCHP.value)",
        "tot": "jsonata"
      },
      {
        "t": "set",
        "p": "payload.PAPP",
        "pt": "msg",
        "to": "$number(msg.payload.PAPP.value)",
        "tot": "jsonata"
      },
      {
        "t": "set",
        "p": "payload.IMAX",
        "pt": "msg",
        "to": "$number(msg.payload.IMAX.value)",
        "tot": "jsonata"
      },
      {
        "t": "set",
        "p": "payload.ISOUSC",
        "pt": "msg",
        "to": "$number(msg.payload.ISOUSC.value)",
        "tot": "jsonata"
      },
      {
        "t": "set",
        "p": "payload.PTEC",
        "pt": "msg",
        "to": "payload.PTEC.value",
        "tot": "msg"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 270,
    "y": 480,
    "wires": [
      [
        "539176543f03340e",
        "6969a430e98620f8"
      ]
    ]
  },
  {
    "id": "1ef3db77515c5330",
    "type": "link in",
    "z": "a1e22fa468f03c15",
    "g": "f65dfdda10900ffc",
    "name": "teleinfo",
    "links": [
      "1f088dee7d4ae695"
    ],
    "x": 135,
    "y": 480,
    "wires": [
      [
        "8546ac1e37b1b1fc"
      ]
    ]
  },
  {
    "id": "df67aa8c4eb08c4b",
    "type": "rbe",
    "z": "a1e22fa468f03c15",
    "g": "f65dfdda10900ffc",
    "name": "",
    "func": "rbe",
    "gap": "",
    "start": "",
    "inout": "out",
    "property": "payload",
    "x": 930,
    "y": 600,
    "wires": [
      [
        "9846cd104deb4095",
        "80713009a92b1fb1"
      ]
    ]
  },
  {
    "id": "6b5f520afcf9e941",
    "type": "rbe",
    "z": "a1e22fa468f03c15",
    "g": "f65dfdda10900ffc",
    "name": "",
    "func": "rbe",
    "gap": "",
    "start": "",
    "inout": "out",
    "property": "payload",
    "x": 930,
    "y": 540,
    "wires": [
      [
        "80713009a92b1fb1"
      ]
    ]
  },
  {
    "id": "1c6a5f6cf7a4171a",
    "type": "rbe",
    "z": "a1e22fa468f03c15",
    "g": "f65dfdda10900ffc",
    "name": "",
    "func": "rbe",
    "gap": "",
    "start": "",
    "inout": "out",
    "septopics": true,
    "property": "payload",
    "topi": "topic",
    "x": 930,
    "y": 840,
    "wires": [
      [
        "80713009a92b1fb1"
      ]
    ]
  },
  {
    "id": "e3ec96cdb6ecec1d",
    "type": "rbe",
    "z": "a1e22fa468f03c15",
    "g": "f65dfdda10900ffc",
    "name": "",
    "func": "rbe",
    "gap": "",
    "start": "",
    "inout": "out",
    "property": "payload",
    "x": 930,
    "y": 660,
    "wires": [
      [
        "cad9f0d374763a50",
        "80713009a92b1fb1"
      ]
    ]
  },
  {
    "id": "2235915bcd1a9228",
    "type": "rbe",
    "z": "a1e22fa468f03c15",
    "g": "f65dfdda10900ffc",
    "name": "",
    "func": "rbe",
    "gap": "",
    "start": "",
    "inout": "out",
    "property": "payload",
    "x": 930,
    "y": 720,
    "wires": [
      [
        "c40a25fa809f3f3f",
        "80713009a92b1fb1"
      ]
    ]
  },
  {
    "id": "df89dd445c170c34",
    "type": "rbe",
    "z": "a1e22fa468f03c15",
    "g": "f65dfdda10900ffc",
    "name": "",
    "func": "rbe",
    "gap": "",
    "start": "",
    "inout": "out",
    "property": "payload",
    "x": 930,
    "y": 900,
    "wires": [
      [
        "80713009a92b1fb1"
      ]
    ]
  },
  {
    "id": "539176543f03340e",
    "type": "delay",
    "z": "a1e22fa468f03c15",
    "g": "f65dfdda10900ffc",
    "name": "1msg/2s",
    "pauseType": "rate",
    "timeout": "5",
    "timeoutUnits": "seconds",
    "rate": "1",
    "nbRateUnits": "2",
    "rateUnits": "second",
    "randomFirst": "1",
    "randomLast": "5",
    "randomUnits": "seconds",
    "drop": true,
    "outputs": 1,
    "x": 440,
    "y": 840,
    "wires": [
      [
        "528d193f3ad76c04",
        "d259cbfd50910254"
      ]
    ]
  },
  {
    "id": "528d193f3ad76c04",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "f65dfdda10900ffc",
    "name": "PAPP",
    "rules": [
      {
        "t": "set",
        "p": "field",
        "pt": "msg",
        "to": "puissance",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "payload",
        "pt": "msg",
        "to": "payload.PAPP",
        "tot": "msg"
      },
      {
        "t": "set",
        "p": "measurement",
        "pt": "msg",
        "to": "W",
        "tot": "str"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 610,
    "y": 900,
    "wires": [
      [
        "06b7f0862564450a"
      ]
    ]
  },
  {
    "id": "d259cbfd50910254",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "f65dfdda10900ffc",
    "name": "IINST",
    "rules": [
      {
        "t": "set",
        "p": "field",
        "pt": "msg",
        "to": "intensite",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "payload",
        "pt": "msg",
        "to": "payload.IINST",
        "tot": "msg"
      },
      {
        "t": "set",
        "p": "measurement",
        "pt": "msg",
        "to": "A",
        "tot": "str"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 610,
    "y": 840,
    "wires": [
      [
        "1c6a5f6cf7a4171a"
      ]
    ]
  },
  {
    "id": "4f66f48da30fbb41",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "f65dfdda10900ffc",
    "name": "INDEX HC WH",
    "rules": [
      {
        "t": "set",
        "p": "field",
        "pt": "msg",
        "to": "index_hc",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "payload",
        "pt": "msg",
        "to": "payload.HCHC",
        "tot": "msg"
      },
      {
        "t": "set",
        "p": "measurement",
        "pt": "msg",
        "to": "Wh",
        "tot": "str"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 640,
    "y": 720,
    "wires": [
      [
        "2235915bcd1a9228"
      ]
    ]
  },
  {
    "id": "5543b63f4f841d35",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "f65dfdda10900ffc",
    "name": "INDEX HP WH",
    "rules": [
      {
        "t": "set",
        "p": "field",
        "pt": "msg",
        "to": "index_hp",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "payload",
        "pt": "msg",
        "to": "payload.HCHP",
        "tot": "msg"
      },
      {
        "t": "set",
        "p": "measurement",
        "pt": "msg",
        "to": "Wh",
        "tot": "str"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 640,
    "y": 660,
    "wires": [
      [
        "e3ec96cdb6ecec1d"
      ]
    ]
  },
  {
    "id": "16e115607aca11e2",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "f65dfdda10900ffc",
    "name": "INDEX TT KWH",
    "rules": [
      {
        "t": "set",
        "p": "field",
        "pt": "msg",
        "to": "index_total",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "payload",
        "pt": "msg",
        "to": "(msg.payload.HCHC+ msg.payload.HCHP) / 1000",
        "tot": "jsonata"
      },
      {
        "t": "set",
        "p": "measurement",
        "pt": "msg",
        "to": "kWh",
        "tot": "str"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 640,
    "y": 540,
    "wires": [
      [
        "6b5f520afcf9e941"
      ]
    ]
  },
  {
    "id": "573b86bbb0b274cd",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "f65dfdda10900ffc",
    "name": "INDEX TT WH",
    "rules": [
      {
        "t": "set",
        "p": "field",
        "pt": "msg",
        "to": "index_total",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "payload",
        "pt": "msg",
        "to": "msg.payload.HCHC+ msg.payload.HCHP",
        "tot": "jsonata"
      },
      {
        "t": "set",
        "p": "measurement",
        "pt": "msg",
        "to": "Wh",
        "tot": "str"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 640,
    "y": 600,
    "wires": [
      [
        "df67aa8c4eb08c4b"
      ]
    ]
  },
  {
    "id": "6969a430e98620f8",
    "type": "delay",
    "z": "a1e22fa468f03c15",
    "g": "f65dfdda10900ffc",
    "name": "1msg/15s",
    "pauseType": "rate",
    "timeout": "5",
    "timeoutUnits": "seconds",
    "rate": "1",
    "nbRateUnits": "15",
    "rateUnits": "second",
    "randomFirst": "1",
    "randomLast": "5",
    "randomUnits": "seconds",
    "drop": true,
    "outputs": 1,
    "x": 440,
    "y": 540,
    "wires": [
      [
        "4f66f48da30fbb41",
        "5543b63f4f841d35",
        "16e115607aca11e2",
        "573b86bbb0b274cd",
        "25a206dee6cb2d38"
      ]
    ]
  },
  {
    "id": "c40a25fa809f3f3f",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "f65dfdda10900ffc",
    "name": "",
    "rules": [
      {
        "t": "set",
        "p": "index_hc_wh",
        "pt": "flow",
        "to": "payload",
        "tot": "msg"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 1150,
    "y": 720,
    "wires": [
      []
    ]
  },
  {
    "id": "cad9f0d374763a50",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "f65dfdda10900ffc",
    "name": "",
    "rules": [
      {
        "t": "set",
        "p": "index_hp_wh",
        "pt": "flow",
        "to": "payload",
        "tot": "msg"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 1150,
    "y": 660,
    "wires": [
      []
    ]
  },
  {
    "id": "9846cd104deb4095",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "f65dfdda10900ffc",
    "name": "",
    "rules": [
      {
        "t": "set",
        "p": "index_total_wh",
        "pt": "flow",
        "to": "payload",
        "tot": "msg"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 1150,
    "y": 600,
    "wires": [
      []
    ]
  },
  {
    "id": "80713009a92b1fb1",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "f65dfdda10900ffc",
    "name": "format",
    "rules": [
      {
        "t": "set",
        "p": "tmp",
        "pt": "msg",
        "to": "payload",
        "tot": "msg"
      },
      {
        "t": "delete",
        "p": "payload",
        "pt": "msg"
      },
      {
        "t": "set",
        "p": "payload[0]",
        "pt": "msg",
        "to": "{msg.field:msg.tmp}",
        "tot": "jsonata"
      },
      {
        "t": "delete",
        "p": "tmp",
        "pt": "msg"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 1090,
    "y": 480,
    "wires": [
      [
        "25b8f66cb5486055"
      ]
    ]
  },
  {
    "id": "25b8f66cb5486055",
    "type": "link out",
    "z": "a1e22fa468f03c15",
    "g": "f65dfdda10900ffc",
    "name": "influxdb",
    "links": [
      "e340056f7c0ff7e6"
    ],
    "x": 1215,
    "y": 480,
    "wires": []
  },
  {
    "id": "25a206dee6cb2d38",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "f65dfdda10900ffc",
    "name": "PTEC",
    "rules": [
      {
        "t": "set",
        "p": "field",
        "pt": "msg",
        "to": "tarif_hp",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "payload",
        "pt": "msg",
        "to": "payload.PTEC",
        "tot": "msg"
      },
      {
        "t": "set",
        "p": "measurement",
        "pt": "msg",
        "to": "T",
        "tot": "str"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 610,
    "y": 780,
    "wires": [
      [
        "10352a4c8044bff8"
      ]
    ]
  },
  {
    "id": "10352a4c8044bff8",
    "type": "function",
    "z": "a1e22fa468f03c15",
    "g": "f65dfdda10900ffc",
    "name": "HPHC",
    "func": "if (msg.payload==\"HP\"){\n    msg.payload=1;\n    return msg;\n}\nelse if(msg.payload==\"HC\"){\n    msg.payload=0;\n    return msg;\n}",
    "outputs": 1,
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 770,
    "y": 780,
    "wires": [
      [
        "d1f398881a976c8c"
      ]
    ]
  },
  {
    "id": "d1f398881a976c8c",
    "type": "rbe",
    "z": "a1e22fa468f03c15",
    "g": "f65dfdda10900ffc",
    "name": "",
    "func": "rbe",
    "gap": "",
    "start": "",
    "inout": "out",
    "property": "payload",
    "x": 930,
    "y": 780,
    "wires": [
      [
        "80713009a92b1fb1"
      ]
    ]
  },
  {
    "id": "e340056f7c0ff7e6",
    "type": "link in",
    "z": "a1e22fa468f03c15",
    "g": "b0150193e3cce710",
    "name": "influxdb",
    "links": [
      "1d84aac6c8e2a838",
      "25b8f66cb5486055",
      "f2de43c0a6cb7bf1"
    ],
    "x": 135,
    "y": 2460,
    "wires": [
      [
        "4f2f651b305df0d8"
      ]
    ]
  },
  {
    "id": "4f2f651b305df0d8",
    "type": "delay",
    "z": "a1e22fa468f03c15",
    "g": "b0150193e3cce710",
    "name": "50ms",
    "pauseType": "delay",
    "timeout": "50",
    "timeoutUnits": "milliseconds",
    "rate": "1",
    "nbRateUnits": "1",
    "rateUnits": "second",
    "randomFirst": "1",
    "randomLast": "5",
    "randomUnits": "seconds",
    "drop": false,
    "outputs": 1,
    "x": 270,
    "y": 2460,
    "wires": [
      [
        "c2bbb4adbb91e2eb",
        "f8e8e4320c84ad84",
        "b20175d86ac76169"
      ]
    ]
  },
  {
    "id": "f8e8e4320c84ad84",
    "type": "debug",
    "z": "a1e22fa468f03c15",
    "g": "b0150193e3cce710",
    "name": "linky to influxdb",
    "active": false,
    "tosidebar": true,
    "console": false,
    "tostatus": false,
    "complete": "true",
    "targetType": "full",
    "statusVal": "",
    "statusType": "auto",
    "x": 460,
    "y": 2400,
    "wires": []
  },
  {
    "id": "b20175d86ac76169",
    "type": "link out",
    "z": "a1e22fa468f03c15",
    "g": "b0150193e3cce710",
    "name": "increment influxdb stat",
    "mode": "link",
    "links": [
      "b4dcaf3216134966"
    ],
    "x": 395,
    "y": 2460,
    "wires": []
  },
  {
    "id": "06e4c17b8ac467e1",
    "type": "join",
    "z": "a1e22fa468f03c15",
    "g": "543a74289e049295",
    "name": "",
    "mode": "custom",
    "build": "object",
    "property": "payload",
    "propertyType": "msg",
    "key": "topic",
    "joiner": "\\n",
    "joinerType": "str",
    "accumulate": false,
    "timeout": "",
    "count": "2",
    "reduceRight": false,
    "reduceExp": "",
    "reduceInit": "",
    "reduceInitType": "",
    "reduceFixup": "",
    "x": 780,
    "y": 1020,
    "wires": [
      [
        "9a0a261261c064da"
      ]
    ]
  },
  {
    "id": "af3687a9f899e8da",
    "type": "function",
    "z": "a1e22fa468f03c15",
    "g": "543a74289e049295",
    "name": "",
    "func": "var old = msg.payload.old.value;\nvar current = msg.payload.new.value;\nvar diff_index = current - old;\n\n\nvar diff_seconds = (msg.payload.new.time - msg.payload.old.time) / 1000;\nif (diff_seconds == 0) {\n    var conso = 0;\n} else {\n    var coeff = diff_seconds / 3600\n    var conso = diff_index / coeff\n    conso = Math.round(conso*100)/100\n}\nvar msg2 = {};\nmsg2.payload = {};\nmsg2.payload.conso = conso;\nmsg2.payload.diff_sec = diff_seconds;\nmsg2.payload.old_time = msg.payload.old.time;\nmsg2.payload.new_time = msg.payload.new.time;\n\nnode.status({fill: \"green\", shape: \"ring\", text: conso});\nreturn msg2;",
    "outputs": 1,
    "timeout": "",
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 1280,
    "y": 1020,
    "wires": [
      [
        "eaf239f4e4fd9d20"
      ]
    ]
  },
  {
    "id": "9a0856ef24c6ecb1",
    "type": "inject",
    "z": "a1e22fa468f03c15",
    "g": "543a74289e049295",
    "name": "",
    "props": [
      {
        "p": "payload"
      },
      {
        "p": "topic",
        "vt": "str"
      }
    ],
    "repeat": "90",
    "crontab": "",
    "once": true,
    "onceDelay": "30",
    "topic": "",
    "payload": "",
    "payloadType": "date",
    "x": 210,
    "y": 1020,
    "wires": [
      [
        "2c63586ece8ae18a",
        "543a55099b4d2327"
      ]
    ]
  },
  {
    "id": "905240083e6bd5a2",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "543a74289e049295",
    "name": "old",
    "rules": [
      {
        "t": "set",
        "p": "topic",
        "pt": "msg",
        "to": "old",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "tmp",
        "pt": "msg",
        "to": "{}",
        "tot": "jsonata"
      },
      {
        "t": "set",
        "p": "tmp.value",
        "pt": "msg",
        "to": "payload[0]._value",
        "tot": "msg"
      },
      {
        "t": "set",
        "p": "tmp.time",
        "pt": "msg",
        "to": "$toMillis(msg.payload[0]._time)",
        "tot": "jsonata"
      },
      {
        "t": "set",
        "p": "payload",
        "pt": "msg",
        "to": "tmp",
        "tot": "msg"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 610,
    "y": 1020,
    "wires": [
      [
        "06e4c17b8ac467e1"
      ]
    ]
  },
  {
    "id": "e57340f8784de737",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "543a74289e049295",
    "name": "new",
    "rules": [
      {
        "t": "set",
        "p": "topic",
        "pt": "msg",
        "to": "new",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "tmp",
        "pt": "msg",
        "to": "{}",
        "tot": "jsonata"
      },
      {
        "t": "set",
        "p": "tmp.value",
        "pt": "msg",
        "to": "payload[0]._value",
        "tot": "msg"
      },
      {
        "t": "set",
        "p": "tmp.time",
        "pt": "msg",
        "to": "$toMillis(msg.payload[0]._time)",
        "tot": "jsonata"
      },
      {
        "t": "set",
        "p": "payload",
        "pt": "msg",
        "to": "tmp",
        "tot": "msg"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 610,
    "y": 1080,
    "wires": [
      [
        "06e4c17b8ac467e1"
      ]
    ]
  },
  {
    "id": "1d84aac6c8e2a838",
    "type": "link out",
    "z": "a1e22fa468f03c15",
    "g": "543a74289e049295",
    "name": "influxdb",
    "links": [
      "e340056f7c0ff7e6"
    ],
    "x": 1575,
    "y": 1020,
    "wires": []
  },
  {
    "id": "eaf239f4e4fd9d20",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "543a74289e049295",
    "name": "format",
    "rules": [
      {
        "t": "set",
        "p": "conso",
        "pt": "msg",
        "to": "$number(msg.payload.conso)",
        "tot": "jsonata"
      },
      {
        "t": "delete",
        "p": "payload",
        "pt": "msg"
      },
      {
        "t": "set",
        "p": "payload[0]",
        "pt": "msg",
        "to": "{\"conso_puissance\":msg.conso}",
        "tot": "jsonata"
      },
      {
        "t": "set",
        "p": "measurement",
        "pt": "msg",
        "to": "W",
        "tot": "str"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 1450,
    "y": 1020,
    "wires": [
      [
        "1d84aac6c8e2a838"
      ]
    ]
  },
  {
    "id": "c84ad49be11b1bd9",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "213d292b79e5fbcc",
    "name": "",
    "rules": [
      {
        "t": "set",
        "p": "index_total_wh_start_day",
        "pt": "flow",
        "to": "index_total_wh",
        "tot": "flow"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 790,
    "y": 1200,
    "wires": [
      []
    ]
  },
  {
    "id": "78a8877be3e75897",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "213d292b79e5fbcc",
    "name": "",
    "rules": [
      {
        "t": "set",
        "p": "index_total_wh_start_month",
        "pt": "flow",
        "to": "index_total_wh",
        "tot": "flow"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 800,
    "y": 1260,
    "wires": [
      []
    ]
  },
  {
    "id": "2b15984780ad93da",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "213d292b79e5fbcc",
    "name": "",
    "rules": [
      {
        "t": "set",
        "p": "index_total_wh_start_year",
        "pt": "flow",
        "to": "index_total_wh",
        "tot": "flow"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 790,
    "y": 1320,
    "wires": [
      []
    ]
  },
  {
    "id": "7e164b153068131f",
    "type": "switch",
    "z": "a1e22fa468f03c15",
    "g": "213d292b79e5fbcc",
    "name": "period select",
    "property": "topic",
    "propertyType": "msg",
    "rules": [
      {
        "t": "eq",
        "v": "day",
        "vt": "str"
      },
      {
        "t": "eq",
        "v": "month",
        "vt": "str"
      },
      {
        "t": "eq",
        "v": "year",
        "vt": "str"
      }
    ],
    "checkall": "true",
    "repair": false,
    "outputs": 3,
    "x": 510,
    "y": 1260,
    "wires": [
      [
        "c84ad49be11b1bd9",
        "c77835080e9f86f2",
        "5b6872ce327b1bf3"
      ],
      [
        "78a8877be3e75897",
        "aaa4d5f3593d6d65",
        "8c5505de0a4d3dcd"
      ],
      [
        "2b15984780ad93da",
        "f897b93a09482883",
        "6430485715d1b2a6"
      ]
    ]
  },
  {
    "id": "cdfbaf7f971088a0",
    "type": "inject",
    "z": "a1e22fa468f03c15",
    "g": "213d292b79e5fbcc",
    "name": "Manual init >> DO NOT PRESS UNTIL REALLY NEEDED >>",
    "props": [
      {
        "p": "payload"
      },
      {
        "p": "topic",
        "vt": "str"
      }
    ],
    "repeat": "",
    "crontab": "",
    "once": false,
    "onceDelay": 0.1,
    "topic": "",
    "payload": "",
    "payloadType": "date",
    "x": 360,
    "y": 1680,
    "wires": [
      [
        "c84ad49be11b1bd9",
        "78a8877be3e75897",
        "2b15984780ad93da",
        "c77835080e9f86f2",
        "aaa4d5f3593d6d65",
        "f897b93a09482883",
        "5b6872ce327b1bf3",
        "8c5505de0a4d3dcd",
        "6430485715d1b2a6"
      ]
    ]
  },
  {
    "id": "c77835080e9f86f2",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "213d292b79e5fbcc",
    "name": "",
    "rules": [
      {
        "t": "set",
        "p": "index_hp_wh_start_day",
        "pt": "flow",
        "to": "index_hp_wh",
        "tot": "flow"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 780,
    "y": 1380,
    "wires": [
      []
    ]
  },
  {
    "id": "aaa4d5f3593d6d65",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "213d292b79e5fbcc",
    "name": "",
    "rules": [
      {
        "t": "set",
        "p": "index_hp_wh_start_month",
        "pt": "flow",
        "to": "index_hp_wh",
        "tot": "flow"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 790,
    "y": 1440,
    "wires": [
      []
    ]
  },
  {
    "id": "f897b93a09482883",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "213d292b79e5fbcc",
    "name": "",
    "rules": [
      {
        "t": "set",
        "p": "index_hp_wh_start_year",
        "pt": "flow",
        "to": "index_hp_wh",
        "tot": "flow"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 780,
    "y": 1500,
    "wires": [
      []
    ]
  },
  {
    "id": "6430485715d1b2a6",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "213d292b79e5fbcc",
    "name": "",
    "rules": [
      {
        "t": "set",
        "p": "index_hc_wh_start_year",
        "pt": "flow",
        "to": "index_hc_wh",
        "tot": "flow"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 780,
    "y": 1680,
    "wires": [
      []
    ]
  },
  {
    "id": "8c5505de0a4d3dcd",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "213d292b79e5fbcc",
    "name": "",
    "rules": [
      {
        "t": "set",
        "p": "index_hc_wh_start_month",
        "pt": "flow",
        "to": "index_hc_wh",
        "tot": "flow"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 790,
    "y": 1620,
    "wires": [
      []
    ]
  },
  {
    "id": "5b6872ce327b1bf3",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "213d292b79e5fbcc",
    "name": "",
    "rules": [
      {
        "t": "set",
        "p": "index_hc_wh_start_day",
        "pt": "flow",
        "to": "index_hc_wh",
        "tot": "flow"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 780,
    "y": 1560,
    "wires": [
      []
    ]
  },
  {
    "id": "82ef8057da8c77aa",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "d0f7ea2cfc4571a3",
    "name": "index_total_wh_end_day",
    "rules": [
      {
        "t": "set",
        "p": "field",
        "pt": "msg",
        "to": "conso_total_day",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "start",
        "pt": "msg",
        "to": "index_total_wh_start_day",
        "tot": "flow"
      },
      {
        "t": "set",
        "p": "end",
        "pt": "msg",
        "to": "index_total_wh",
        "tot": "flow"
      },
      {
        "t": "set",
        "p": "payload",
        "pt": "msg",
        "to": "$number(msg.end) - $number(msg.start)",
        "tot": "jsonata"
      },
      {
        "t": "set",
        "p": "index_total_wh_end_day",
        "pt": "flow",
        "to": "end",
        "tot": "msg"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 450,
    "y": 1800,
    "wires": [
      [
        "9a2254b818f75188"
      ]
    ]
  },
  {
    "id": "6c25a04857d1716e",
    "type": "inject",
    "z": "a1e22fa468f03c15",
    "g": "d0f7ea2cfc4571a3",
    "name": "",
    "props": [
      {
        "p": "payload"
      },
      {
        "p": "topic",
        "vt": "str"
      }
    ],
    "repeat": "60",
    "crontab": "",
    "once": true,
    "onceDelay": "10",
    "topic": "",
    "payload": "",
    "payloadType": "date",
    "x": 210,
    "y": 1800,
    "wires": [
      [
        "82ef8057da8c77aa",
        "86b0a6aba2f70fe6",
        "9bc81eccbc500c73",
        "997f6535a7397b5d",
        "b4e36b962e02a910",
        "38fbbacd76a1ebc8",
        "bcd49af0e6417d46",
        "7a20b1c05a7278f5",
        "c548f2f0529f2243"
      ]
    ]
  },
  {
    "id": "f2de43c0a6cb7bf1",
    "type": "link out",
    "z": "a1e22fa468f03c15",
    "g": "d0f7ea2cfc4571a3",
    "name": "influxdb",
    "links": [
      "e340056f7c0ff7e6"
    ],
    "x": 855,
    "y": 1800,
    "wires": []
  },
  {
    "id": "9a2254b818f75188",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "d0f7ea2cfc4571a3",
    "name": "format",
    "rules": [
      {
        "t": "set",
        "p": "index",
        "pt": "msg",
        "to": "payload",
        "tot": "msg"
      },
      {
        "t": "delete",
        "p": "payload",
        "pt": "msg"
      },
      {
        "t": "set",
        "p": "payload[0]",
        "pt": "msg",
        "to": "{msg.field:msg.index}",
        "tot": "jsonata"
      },
      {
        "t": "set",
        "p": "measurement",
        "pt": "msg",
        "to": "Wh",
        "tot": "str"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 730,
    "y": 1800,
    "wires": [
      [
        "f2de43c0a6cb7bf1"
      ]
    ]
  },
  {
    "id": "86b0a6aba2f70fe6",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "d0f7ea2cfc4571a3",
    "name": "index_total_wh_end_month",
    "rules": [
      {
        "t": "set",
        "p": "field",
        "pt": "msg",
        "to": "conso_total_month",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "start",
        "pt": "msg",
        "to": "index_total_wh_start_month",
        "tot": "flow"
      },
      {
        "t": "set",
        "p": "end",
        "pt": "msg",
        "to": "index_total_wh",
        "tot": "flow"
      },
      {
        "t": "set",
        "p": "payload",
        "pt": "msg",
        "to": "$number(msg.end) - $number(msg.start)",
        "tot": "jsonata"
      },
      {
        "t": "set",
        "p": "index_total_wh_end_month",
        "pt": "flow",
        "to": "end",
        "tot": "msg"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 460,
    "y": 1860,
    "wires": [
      [
        "9a2254b818f75188"
      ]
    ]
  },
  {
    "id": "9bc81eccbc500c73",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "d0f7ea2cfc4571a3",
    "name": "index_total_wh_end_year",
    "rules": [
      {
        "t": "set",
        "p": "field",
        "pt": "msg",
        "to": "conso_total_year",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "start",
        "pt": "msg",
        "to": "index_total_wh_start_year",
        "tot": "flow"
      },
      {
        "t": "set",
        "p": "end",
        "pt": "msg",
        "to": "index_total_wh",
        "tot": "flow"
      },
      {
        "t": "set",
        "p": "payload",
        "pt": "msg",
        "to": "$number(msg.end) - $number(msg.start)",
        "tot": "jsonata"
      },
      {
        "t": "set",
        "p": "index_total_wh_end_year",
        "pt": "flow",
        "to": "end",
        "tot": "msg"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 450,
    "y": 1920,
    "wires": [
      [
        "9a2254b818f75188"
      ]
    ]
  },
  {
    "id": "997f6535a7397b5d",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "d0f7ea2cfc4571a3",
    "name": "index_hp_wh_end_day",
    "rules": [
      {
        "t": "set",
        "p": "field",
        "pt": "msg",
        "to": "conso_hp_day",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "start",
        "pt": "msg",
        "to": "index_hp_wh_start_day",
        "tot": "flow"
      },
      {
        "t": "set",
        "p": "end",
        "pt": "msg",
        "to": "index_hp_wh",
        "tot": "flow"
      },
      {
        "t": "set",
        "p": "payload",
        "pt": "msg",
        "to": "$number(msg.end) - $number(msg.start)",
        "tot": "jsonata"
      },
      {
        "t": "set",
        "p": "index_hp_wh_end_day",
        "pt": "flow",
        "to": "end",
        "tot": "msg"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 450,
    "y": 1980,
    "wires": [
      [
        "9a2254b818f75188"
      ]
    ]
  },
  {
    "id": "c548f2f0529f2243",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "d0f7ea2cfc4571a3",
    "name": "index_hp_wh_end_month",
    "rules": [
      {
        "t": "set",
        "p": "field",
        "pt": "msg",
        "to": "conso_hp_month",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "start",
        "pt": "msg",
        "to": "index_hp_wh_start_month",
        "tot": "flow"
      },
      {
        "t": "set",
        "p": "end",
        "pt": "msg",
        "to": "index_hp_wh",
        "tot": "flow"
      },
      {
        "t": "set",
        "p": "payload",
        "pt": "msg",
        "to": "$number(msg.end) - $number(msg.start)",
        "tot": "jsonata"
      },
      {
        "t": "set",
        "p": "index_hp_wh_end_month",
        "pt": "flow",
        "to": "end",
        "tot": "msg"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 450,
    "y": 2040,
    "wires": [
      [
        "9a2254b818f75188"
      ]
    ]
  },
  {
    "id": "b4e36b962e02a910",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "d0f7ea2cfc4571a3",
    "name": "index_hp_wh_end_year",
    "rules": [
      {
        "t": "set",
        "p": "field",
        "pt": "msg",
        "to": "conso_hp_year",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "start",
        "pt": "msg",
        "to": "index_hp_wh_start_year",
        "tot": "flow"
      },
      {
        "t": "set",
        "p": "end",
        "pt": "msg",
        "to": "index_hp_wh",
        "tot": "flow"
      },
      {
        "t": "set",
        "p": "payload",
        "pt": "msg",
        "to": "$number(msg.end) - $number(msg.start)",
        "tot": "jsonata"
      },
      {
        "t": "set",
        "p": "index_hp_wh_end_year",
        "pt": "flow",
        "to": "end",
        "tot": "msg"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 450,
    "y": 2100,
    "wires": [
      [
        "9a2254b818f75188"
      ]
    ]
  },
  {
    "id": "38fbbacd76a1ebc8",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "d0f7ea2cfc4571a3",
    "name": "index_hc_wh_end_day",
    "rules": [
      {
        "t": "set",
        "p": "field",
        "pt": "msg",
        "to": "conso_hc_day",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "start",
        "pt": "msg",
        "to": "index_hc_wh_start_day",
        "tot": "flow"
      },
      {
        "t": "set",
        "p": "end",
        "pt": "msg",
        "to": "index_hc_wh",
        "tot": "flow"
      },
      {
        "t": "set",
        "p": "payload",
        "pt": "msg",
        "to": "$number(msg.end) - $number(msg.start)",
        "tot": "jsonata"
      },
      {
        "t": "set",
        "p": "index_hc_wh_end_day",
        "pt": "flow",
        "to": "end",
        "tot": "msg"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 440,
    "y": 2160,
    "wires": [
      [
        "9a2254b818f75188"
      ]
    ]
  },
  {
    "id": "bcd49af0e6417d46",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "d0f7ea2cfc4571a3",
    "name": "index_hc_wh_end_month",
    "rules": [
      {
        "t": "set",
        "p": "field",
        "pt": "msg",
        "to": "conso_hc_month",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "start",
        "pt": "msg",
        "to": "index_hc_wh_start_month",
        "tot": "flow"
      },
      {
        "t": "set",
        "p": "end",
        "pt": "msg",
        "to": "index_hc_wh",
        "tot": "flow"
      },
      {
        "t": "set",
        "p": "payload",
        "pt": "msg",
        "to": "$number(msg.end) - $number(msg.start)",
        "tot": "jsonata"
      },
      {
        "t": "set",
        "p": "index_hc_wh_end_month",
        "pt": "flow",
        "to": "end",
        "tot": "msg"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 450,
    "y": 2220,
    "wires": [
      [
        "9a2254b818f75188"
      ]
    ]
  },
  {
    "id": "7a20b1c05a7278f5",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "d0f7ea2cfc4571a3",
    "name": "index_hc_wh_end_year",
    "rules": [
      {
        "t": "set",
        "p": "field",
        "pt": "msg",
        "to": "conso_hc_year",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "start",
        "pt": "msg",
        "to": "index_hc_wh_start_year",
        "tot": "flow"
      },
      {
        "t": "set",
        "p": "end",
        "pt": "msg",
        "to": "index_hc_wh",
        "tot": "flow"
      },
      {
        "t": "set",
        "p": "payload",
        "pt": "msg",
        "to": "$number(msg.end) - $number(msg.start)",
        "tot": "jsonata"
      },
      {
        "t": "set",
        "p": "index_hc_wh_end_year",
        "pt": "flow",
        "to": "end",
        "tot": "msg"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 450,
    "y": 2280,
    "wires": [
      [
        "9a2254b818f75188"
      ]
    ]
  },
  {
    "id": "96d8b83164d22086",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "9cd020968fe2a19d",
    "name": "config / offloading current limit / number / 42",
    "rules": [
      {
        "t": "set",
        "p": "measurement",
        "pt": "msg",
        "to": "config",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "field",
        "pt": "msg",
        "to": "offloading current limit",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "format",
        "pt": "msg",
        "to": "number",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "default",
        "pt": "msg",
        "to": "42",
        "tot": "num"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 390,
    "y": 2760,
    "wires": [
      [
        "2a688b0630f5cca4"
      ]
    ]
  },
  {
    "id": "2a688b0630f5cca4",
    "type": "link out",
    "z": "a1e22fa468f03c15",
    "g": "9cd020968fe2a19d",
    "name": "linky - config - device",
    "mode": "link",
    "links": [
      "bfa594bf1f876c92"
    ],
    "x": 675,
    "y": 2700,
    "wires": []
  },
  {
    "id": "60a457c83fc5f610",
    "type": "link in",
    "z": "a1e22fa468f03c15",
    "g": "9cd020968fe2a19d",
    "name": "linky - config - device",
    "links": [
      "0ad08e9e45d5435d"
    ],
    "x": 135,
    "y": 2700,
    "wires": [
      [
        "96d8b83164d22086",
        "b52eeb9d79637d39",
        "33c0603ad410d85c"
      ]
    ]
  },
  {
    "id": "b52eeb9d79637d39",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "9cd020968fe2a19d",
    "name": "config / offloading reset delay / number / 15",
    "rules": [
      {
        "t": "set",
        "p": "measurement",
        "pt": "msg",
        "to": "config",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "field",
        "pt": "msg",
        "to": "offloading reset delay",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "format",
        "pt": "msg",
        "to": "number",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "default",
        "pt": "msg",
        "to": "15",
        "tot": "num"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 390,
    "y": 2820,
    "wires": [
      [
        "2a688b0630f5cca4"
      ]
    ]
  },
  {
    "id": "7e386532c9061f5e",
    "type": "link in",
    "z": "a1e22fa468f03c15",
    "g": "2cdbc171bc86cb06",
    "name": "linky - config - ui - metric",
    "links": [
      "031a6afd8300356a"
    ],
    "x": 855,
    "y": 2700,
    "wires": [
      [
        "876d9a75aa665dc1"
      ]
    ]
  },
  {
    "id": "778b0602db797687",
    "type": "switch",
    "z": "a1e22fa468f03c15",
    "g": "2cdbc171bc86cb06",
    "name": "path",
    "property": "path",
    "propertyType": "msg",
    "rules": [
      {
        "t": "eq",
        "v": "msg.bucket & '/config/linky id'",
        "vt": "jsonata"
      },
      {
        "t": "eq",
        "v": "msg.bucket & '/config/offloading current limit'",
        "vt": "jsonata"
      },
      {
        "t": "eq",
        "v": "msg.bucket & '/config/offloading reset delay'",
        "vt": "jsonata"
      }
    ],
    "checkall": "false",
    "repair": false,
    "outputs": 3,
    "x": 1150,
    "y": 2700,
    "wires": [
      [
        "b8a1f342f4e14446"
      ],
      [
        "3c6f3e3cd994cec9"
      ],
      [
        "d997a0effd6d0126"
      ]
    ]
  },
  {
    "id": "876d9a75aa665dc1",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "2cdbc171bc86cb06",
    "name": "bucket",
    "rules": [
      {
        "t": "set",
        "p": "bucket",
        "pt": "msg",
        "to": "bucket",
        "tot": "flow"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 990,
    "y": 2700,
    "wires": [
      [
        "778b0602db797687"
      ]
    ]
  },
  {
    "id": "9a7fb4052f4efa9d",
    "type": "link out",
    "z": "a1e22fa468f03c15",
    "g": "2cdbc171bc86cb06",
    "name": "linky - config - ui - metric",
    "mode": "link",
    "links": [
      "206c1fb4a48067df"
    ],
    "x": 1715,
    "y": 2760,
    "wires": []
  },
  {
    "id": "7472a7716d5e79fb",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "2cdbc171bc86cb06",
    "name": "set metric",
    "rules": [
      {
        "t": "set",
        "p": "bucket",
        "pt": "msg",
        "to": "bucket",
        "tot": "flow"
      },
      {
        "t": "set",
        "p": "measurement",
        "pt": "msg",
        "to": "config",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "field",
        "pt": "msg",
        "to": "topic",
        "tot": "msg"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 1580,
    "y": 2760,
    "wires": [
      [
        "9a7fb4052f4efa9d"
      ]
    ]
  },
  {
    "id": "7a340e512e7cec9a",
    "type": "link in",
    "z": "a1e22fa468f03c15",
    "g": "2cdbc171bc86cb06",
    "name": "linky - config - ui -load",
    "links": [
      "94c79b8f52f0b6ba"
    ],
    "x": 855,
    "y": 2760,
    "wires": [
      [
        "6ed80a0ca731e211",
        "18fc113bdb7e4440",
        "7162b7919ee04e41"
      ]
    ]
  },
  {
    "id": "6ed80a0ca731e211",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "2cdbc171bc86cb06",
    "name": "from global",
    "rules": [
      {
        "t": "set",
        "p": "payload",
        "pt": "msg",
        "to": "metrics.linky.config['offloading current limit']",
        "tot": "global"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 1010,
    "y": 2820,
    "wires": [
      [
        "3c6f3e3cd994cec9"
      ]
    ]
  },
  {
    "id": "3c6f3e3cd994cec9",
    "type": "ui-slider",
    "z": "a1e22fa468f03c15",
    "g": "2cdbc171bc86cb06",
    "group": "611358544679e8cf",
    "name": "",
    "label": "Intensité de délestage",
    "tooltip": "",
    "order": 2,
    "width": 0,
    "height": 0,
    "passthru": false,
    "outs": "end",
    "topic": "offloading current limit",
    "topicType": "str",
    "thumbLabel": true,
    "min": "5",
    "max": "45",
    "step": "1",
    "className": "",
    "x": 1360,
    "y": 2820,
    "wires": [
      [
        "7472a7716d5e79fb"
      ]
    ]
  },
  {
    "id": "18fc113bdb7e4440",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "2cdbc171bc86cb06",
    "name": "from global",
    "rules": [
      {
        "t": "set",
        "p": "payload",
        "pt": "msg",
        "to": "metrics.linky.config['offloading reset delay']",
        "tot": "global"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 1010,
    "y": 2880,
    "wires": [
      [
        "d997a0effd6d0126"
      ]
    ]
  },
  {
    "id": "d997a0effd6d0126",
    "type": "ui-slider",
    "z": "a1e22fa468f03c15",
    "g": "2cdbc171bc86cb06",
    "group": "611358544679e8cf",
    "name": "",
    "label": "Délai de réinitialisation",
    "tooltip": "",
    "order": 3,
    "width": 0,
    "height": 0,
    "passthru": false,
    "outs": "end",
    "topic": "offloading reset delay",
    "topicType": "str",
    "thumbLabel": true,
    "min": "1",
    "max": "60",
    "step": "1",
    "className": "",
    "x": 1360,
    "y": 2880,
    "wires": [
      [
        "7472a7716d5e79fb"
      ]
    ]
  },
  {
    "id": "8a93715d93e96ec9",
    "type": "link in",
    "z": "a1e22fa468f03c15",
    "g": "14bfb846eebf04b4",
    "name": "linky - scene - current to offloading",
    "links": [
      "031a6afd8300356a"
    ],
    "x": 135,
    "y": 3600,
    "wires": [
      [
        "ab2015a7036a8a2d"
      ]
    ]
  },
  {
    "id": "ab2015a7036a8a2d",
    "type": "switch",
    "z": "a1e22fa468f03c15",
    "g": "14bfb846eebf04b4",
    "name": "trigger",
    "property": "path",
    "propertyType": "msg",
    "rules": [
      {
        "t": "eq",
        "v": "home/linky/current",
        "vt": "str"
      },
      {
        "t": "eq",
        "v": "system/mode/offloading",
        "vt": "str"
      }
    ],
    "checkall": "false",
    "repair": false,
    "outputs": 2,
    "x": 270,
    "y": 3600,
    "wires": [
      [
        "4d9eef91906c3f6b"
      ],
      [
        "4638c42f2e097580"
      ]
    ]
  },
  {
    "id": "d5fc9c7840e287c6",
    "type": "switch",
    "z": "a1e22fa468f03c15",
    "g": "14bfb846eebf04b4",
    "name": "current limit",
    "property": "payload",
    "propertyType": "msg",
    "rules": [
      {
        "t": "gte",
        "v": "metrics.linky.config['offloading current limit']",
        "vt": "global"
      }
    ],
    "checkall": "false",
    "repair": false,
    "outputs": 1,
    "x": 1090,
    "y": 3600,
    "wires": [
      [
        "2aaa6917be59ea44"
      ]
    ]
  },
  {
    "id": "4d9eef91906c3f6b",
    "type": "switch",
    "z": "a1e22fa468f03c15",
    "g": "14bfb846eebf04b4",
    "name": "mode master",
    "property": "metrics.system.mode.master",
    "propertyType": "global",
    "rules": [
      {
        "t": "eq",
        "v": "about.automate",
        "vt": "global"
      }
    ],
    "checkall": "false",
    "repair": false,
    "outputs": 1,
    "x": 450,
    "y": 3600,
    "wires": [
      [
        "5ac5e9a27184058b"
      ]
    ]
  },
  {
    "id": "5ac5e9a27184058b",
    "type": "switch",
    "z": "a1e22fa468f03c15",
    "g": "14bfb846eebf04b4",
    "name": "mode automate",
    "property": "metrics.system.mode.automate",
    "propertyType": "global",
    "rules": [
      {
        "t": "eq",
        "v": "automatic",
        "vt": "str"
      }
    ],
    "checkall": "false",
    "repair": false,
    "outputs": 1,
    "x": 660,
    "y": 3600,
    "wires": [
      [
        "71d2809882564006"
      ]
    ]
  },
  {
    "id": "71d2809882564006",
    "type": "switch",
    "z": "a1e22fa468f03c15",
    "g": "14bfb846eebf04b4",
    "name": "mode offloading",
    "property": "metrics.system.mode.offloading",
    "propertyType": "global",
    "rules": [
      {
        "t": "neq",
        "v": "off",
        "vt": "str"
      }
    ],
    "checkall": "false",
    "repair": false,
    "outputs": 1,
    "x": 880,
    "y": 3600,
    "wires": [
      [
        "d5fc9c7840e287c6"
      ]
    ]
  },
  {
    "id": "b497d6eeef074cdf",
    "type": "trigger",
    "z": "a1e22fa468f03c15",
    "g": "14bfb846eebf04b4",
    "name": "set offloaded then automatic",
    "op1": "offloaded",
    "op2": "automatic",
    "op1type": "str",
    "op2type": "str",
    "duration": "1",
    "extend": true,
    "overrideDelay": true,
    "units": "min",
    "reset": "",
    "bytopic": "all",
    "topic": "topic",
    "outputs": 1,
    "x": 1500,
    "y": 3600,
    "wires": [
      [
        "c34352d41e16989c"
      ]
    ]
  },
  {
    "id": "a97c1309cdf39d94",
    "type": "link out",
    "z": "a1e22fa468f03c15",
    "g": "14bfb846eebf04b4",
    "name": "linky - scene - current to offloading",
    "mode": "link",
    "links": [
      "206c1fb4a48067df"
    ],
    "x": 1875,
    "y": 3600,
    "wires": []
  },
  {
    "id": "c34352d41e16989c",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "14bfb846eebf04b4",
    "name": "set topic",
    "rules": [
      {
        "t": "set",
        "p": "topic",
        "pt": "msg",
        "to": "device/system/mode/offloading",
        "tot": "str"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 1740,
    "y": 3600,
    "wires": [
      [
        "a97c1309cdf39d94"
      ]
    ]
  },
  {
    "id": "4638c42f2e097580",
    "type": "switch",
    "z": "a1e22fa468f03c15",
    "g": "14bfb846eebf04b4",
    "name": "mode offloading",
    "property": "payload",
    "propertyType": "msg",
    "rules": [
      {
        "t": "neq",
        "v": "offloaded",
        "vt": "str"
      }
    ],
    "checkall": "false",
    "repair": false,
    "outputs": 1,
    "x": 460,
    "y": 3660,
    "wires": [
      [
        "bcab76bcab7be22c"
      ]
    ]
  },
  {
    "id": "bcab76bcab7be22c",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "14bfb846eebf04b4",
    "name": "reset",
    "rules": [
      {
        "t": "set",
        "p": "reset",
        "pt": "msg",
        "to": "true",
        "tot": "bool"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 1110,
    "y": 3660,
    "wires": [
      [
        "2aaa6917be59ea44"
      ]
    ]
  },
  {
    "id": "2aaa6917be59ea44",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "14bfb846eebf04b4",
    "name": "delay",
    "rules": [
      {
        "t": "set",
        "p": "delay",
        "pt": "msg",
        "to": "metrics.linky.config['offloading reset delay']",
        "tot": "global"
      },
      {
        "t": "set",
        "p": "delay",
        "pt": "msg",
        "to": "$number(msg.delay)=0?1:msg.delay",
        "tot": "jsonata"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 1270,
    "y": 3600,
    "wires": [
      [
        "b497d6eeef074cdf"
      ]
    ]
  },
  {
    "id": "c2bbb4adbb91e2eb",
    "type": "influxdb out",
    "z": "a1e22fa468f03c15",
    "g": "b0150193e3cce710",
    "influxdb": "e408b55d1dc6870d",
    "name": "linky",
    "measurement": "",
    "precision": "",
    "retentionPolicy": "",
    "database": "",
    "precisionV18FluxV20": "s",
    "retentionPolicyV18Flux": "",
    "org": "iotredloop",
    "bucket": "linky",
    "x": 430,
    "y": 2520,
    "wires": []
  },
  {
    "id": "2c63586ece8ae18a",
    "type": "influxdb in",
    "z": "a1e22fa468f03c15",
    "g": "543a74289e049295",
    "influxdb": "e408b55d1dc6870d",
    "name": "2min ago index",
    "query": "from(bucket: \"linky\")\n  |> range(start: -120s, stop: now())\n  |> filter(fn: (r) => r[\"_field\"] == \"index_total\" and r[\"_measurement\"] == \"Wh\")\n  |> aggregateWindow(every: 1s, fn: last, createEmpty: false)\n  |> sort(columns: [\"_time\"], desc: false)\n  |> yield(name: \"last\")",
    "rawOutput": false,
    "precision": "",
    "retentionPolicy": "",
    "org": "iotredloop",
    "x": 420,
    "y": 1020,
    "wires": [
      [
        "905240083e6bd5a2"
      ]
    ]
  },
  {
    "id": "543a55099b4d2327",
    "type": "influxdb in",
    "z": "a1e22fa468f03c15",
    "g": "543a74289e049295",
    "influxdb": "e408b55d1dc6870d",
    "name": "last index",
    "query": "from(bucket: \"linky\")\n  |> range(start: -60s, stop: now())\n  |> filter(fn: (r) => r[\"_field\"] == \"index_total\" and r[\"_measurement\"] == \"Wh\")\n  |> aggregateWindow(every: 1s, fn: last, createEmpty: false)\n  |> sort(columns: [\"_time\"], desc: true)\n  |> yield(name: \"last\")",
    "rawOutput": false,
    "precision": "",
    "retentionPolicy": "",
    "org": "iotredloop",
    "x": 400,
    "y": 1080,
    "wires": [
      [
        "e57340f8784de737"
      ]
    ]
  },
  {
    "id": "1cde90641d601c65",
    "type": "cronplus",
    "z": "a1e22fa468f03c15",
    "g": "213d292b79e5fbcc",
    "name": "start periods",
    "outputField": "payload",
    "timeZone": "",
    "storeName": "",
    "commandResponseMsgOutput": "output2",
    "defaultLocation": "",
    "defaultLocationType": "default",
    "outputs": 2,
    "options": [
      {
        "name": "day",
        "topic": "day",
        "payloadType": "default",
        "payload": "",
        "expressionType": "cron",
        "expression": "0 0 0 * * ? *",
        "location": "",
        "offset": "0",
        "solarType": "all",
        "solarEvents": "sunrise,sunset"
      },
      {
        "name": "month",
        "topic": "month",
        "payloadType": "default",
        "payload": "",
        "expressionType": "cron",
        "expression": "0 0 0 1 * ? *",
        "location": "",
        "offset": "0",
        "solarType": "all",
        "solarEvents": "sunrise,sunset"
      },
      {
        "name": "year",
        "topic": "year",
        "payloadType": "default",
        "payload": "",
        "expressionType": "cron",
        "expression": "0 0 0 1 1 ? *",
        "location": "",
        "offset": "0",
        "solarType": "all",
        "solarEvents": "sunrise,sunset"
      }
    ],
    "x": 210,
    "y": 1260,
    "wires": [
      [
        "7e164b153068131f"
      ],
      []
    ]
  },
  {
    "id": "5f80823cb39801f0",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "9cd020968fe2a19d",
    "name": "config / linky id / number",
    "rules": [
      {
        "t": "set",
        "p": "measurement",
        "pt": "msg",
        "to": "config",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "field",
        "pt": "msg",
        "to": "linky id",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "format",
        "pt": "msg",
        "to": "text",
        "tot": "str"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 490,
    "y": 2700,
    "wires": [
      [
        "2a688b0630f5cca4"
      ]
    ]
  },
  {
    "id": "7162b7919ee04e41",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "2cdbc171bc86cb06",
    "name": "from global",
    "rules": [
      {
        "t": "set",
        "p": "payload",
        "pt": "msg",
        "to": "metrics.linky.config['linky id']",
        "tot": "global"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 1010,
    "y": 2760,
    "wires": [
      [
        "b8a1f342f4e14446"
      ]
    ]
  },
  {
    "id": "b8a1f342f4e14446",
    "type": "ui-text-input",
    "z": "a1e22fa468f03c15",
    "g": "2cdbc171bc86cb06",
    "group": "611358544679e8cf",
    "name": "linky id",
    "label": "Linky ID",
    "order": 1,
    "width": "6",
    "height": "1",
    "topic": "linky id",
    "topicType": "str",
    "mode": "text",
    "delay": 300,
    "passthru": false,
    "sendOnDelay": false,
    "sendOnBlur": true,
    "sendOnEnter": true,
    "className": "",
    "x": 1310,
    "y": 2760,
    "wires": [
      [
        "7472a7716d5e79fb"
      ]
    ]
  },
  {
    "id": "33c0603ad410d85c",
    "type": "credentials",
    "z": "a1e22fa468f03c15",
    "g": "9cd020968fe2a19d",
    "name": "linky id",
    "props": [
      {
        "value": "default",
        "type": "msg"
      }
    ],
    "x": 270,
    "y": 2700,
    "wires": [
      [
        "5f80823cb39801f0"
      ]
    ]
  },
  {
    "id": "6f11b20b69a42029",
    "type": "catch",
    "z": "a1e22fa468f03c15",
    "g": "8a97ad21fb974dbd",
    "name": "catch error",
    "scope": null,
    "uncaught": false,
    "x": 620,
    "y": 60,
    "wires": [
      [
        "31fc5fdc93b7363d"
      ]
    ]
  },
  {
    "id": "31fc5fdc93b7363d",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "8a97ad21fb974dbd",
    "name": "topic",
    "rules": [
      {
        "t": "set",
        "p": "topic",
        "pt": "msg",
        "to": "linky",
        "tot": "str"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 790,
    "y": 60,
    "wires": [
      [
        "d7b616f51fec6d9a"
      ]
    ]
  },
  {
    "id": "d7b616f51fec6d9a",
    "type": "link out",
    "z": "a1e22fa468f03c15",
    "g": "8a97ad21fb974dbd",
    "name": "catch error",
    "mode": "link",
    "links": [
      "a52f0e788cd4dca3"
    ],
    "x": 915,
    "y": 60,
    "wires": []
  },
  {
    "id": "c16f1ae420f44fb5",
    "type": "mqtt in",
    "z": "a1e22fa468f03c15",
    "g": "fee31a77e542b203",
    "name": "MQTT teleinfo",
    "topic": "teleinfo/#",
    "qos": "2",
    "datatype": "auto-detect",
    "broker": "d6ba6007b1901314",
    "nl": false,
    "rap": true,
    "rh": 0,
    "inputs": 0,
    "x": 190,
    "y": 240,
    "wires": [
      [
        "fa2acb5ac9bb8c8c"
      ]
    ]
  },
  {
    "id": "b491f7eb02575108",
    "type": "link out",
    "z": "a1e22fa468f03c15",
    "g": "fee31a77e542b203",
    "name": "mqtt teleinfo",
    "mode": "link",
    "links": [
      "112f15815d373541",
      "44a6b39d960c738d",
      "acc79920bf40652d"
    ],
    "x": 1215,
    "y": 240,
    "wires": []
  },
  {
    "id": "ca7f0d58c55a1358",
    "type": "q-gate",
    "z": "a1e22fa468f03c15",
    "g": "fee31a77e542b203",
    "name": "",
    "controlTopic": "gate",
    "defaultState": "queueing",
    "openCmd": "open",
    "closeCmd": "close",
    "toggleCmd": "toggle",
    "queueCmd": "close",
    "defaultCmd": "default",
    "triggerCmd": "trigger",
    "flushCmd": "open",
    "resetCmd": "reset",
    "peekCmd": "peek",
    "dropCmd": "drop",
    "statusCmd": "status",
    "maxQueueLength": "0",
    "keepNewest": false,
    "qToggle": false,
    "persist": false,
    "storeName": "default",
    "x": 590,
    "y": 240,
    "wires": [
      [
        "a34aeb4c51bcf655"
      ]
    ]
  },
  {
    "id": "3423fd727184042c",
    "type": "link in",
    "z": "a1e22fa468f03c15",
    "g": "fee31a77e542b203",
    "name": "mqtt teleinfo gate",
    "links": [
      "d68d686bbf684c95",
      "8fdb5986494986cc"
    ],
    "x": 455,
    "y": 300,
    "wires": [
      [
        "ca7f0d58c55a1358"
      ]
    ]
  },
  {
    "id": "fa2acb5ac9bb8c8c",
    "type": "delay",
    "z": "a1e22fa468f03c15",
    "g": "fee31a77e542b203",
    "name": "20 msg / s",
    "pauseType": "rate",
    "timeout": "5",
    "timeoutUnits": "seconds",
    "rate": "20",
    "nbRateUnits": "1",
    "rateUnits": "second",
    "randomFirst": "1",
    "randomLast": "5",
    "randomUnits": "seconds",
    "drop": false,
    "allowrate": false,
    "outputs": 1,
    "x": 390,
    "y": 240,
    "wires": [
      [
        "ca7f0d58c55a1358"
      ]
    ]
  },
  {
    "id": "a34aeb4c51bcf655",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "fee31a77e542b203",
    "name": "raz MQTT properties",
    "rules": [
      {
        "t": "delete",
        "p": "qos",
        "pt": "msg"
      },
      {
        "t": "delete",
        "p": "retain",
        "pt": "msg"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 1040,
    "y": 240,
    "wires": [
      [
        "b491f7eb02575108"
      ]
    ]
  },
  {
    "id": "b0b2d9829230be99",
    "type": "mqtt out",
    "z": "a1e22fa468f03c15",
    "g": "0bf16a20b9656c59",
    "name": "MQTT teleinfo",
    "topic": "",
    "qos": "",
    "retain": "",
    "respTopic": "",
    "contentType": "",
    "userProps": "",
    "correl": "",
    "expiry": "",
    "broker": "d6ba6007b1901314",
    "x": 1760,
    "y": 240,
    "wires": []
  },
  {
    "id": "5d53068f8b9e6936",
    "type": "link in",
    "z": "a1e22fa468f03c15",
    "d": true,
    "g": "0bf16a20b9656c59",
    "name": "mqtt teleinfo",
    "links": [],
    "x": 1395,
    "y": 240,
    "wires": [
      [
        "7a6db5a28141b284"
      ]
    ]
  },
  {
    "id": "a7e18f888c96ad05",
    "type": "link out",
    "z": "a1e22fa468f03c15",
    "g": "0bf16a20b9656c59",
    "name": "mqtt teleinfo output",
    "mode": "link",
    "links": [],
    "x": 1695,
    "y": 300,
    "wires": []
  },
  {
    "id": "7a6db5a28141b284",
    "type": "switch",
    "z": "a1e22fa468f03c15",
    "g": "0bf16a20b9656c59",
    "name": "check topic",
    "property": "topic",
    "propertyType": "msg",
    "rules": [
      {
        "t": "regex",
        "v": "^teleinfo",
        "vt": "str",
        "case": false
      }
    ],
    "checkall": "false",
    "repair": false,
    "outputs": 1,
    "x": 1550,
    "y": 240,
    "wires": [
      [
        "b0b2d9829230be99",
        "a7e18f888c96ad05"
      ]
    ]
  },
  {
    "id": "9a7347381e1e503b",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "f36ad9add0dea84a",
    "name": "current",
    "rules": [
      {
        "t": "set",
        "p": "field",
        "pt": "msg",
        "to": "current",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "payload",
        "pt": "msg",
        "to": "$number(msg.payload.IINST.value)",
        "tot": "jsonata"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 1340,
    "y": 3060,
    "wires": [
      [
        "4587eb595b780266"
      ]
    ]
  },
  {
    "id": "cb99733f4cbf651a",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "f36ad9add0dea84a",
    "name": "set metric",
    "rules": [
      {
        "t": "set",
        "p": "bucket",
        "pt": "msg",
        "to": "home",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "measurement",
        "pt": "msg",
        "to": "linky",
        "tot": "str"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 1820,
    "y": 3060,
    "wires": [
      [
        "d16064888745aca6"
      ]
    ]
  },
  {
    "id": "d16064888745aca6",
    "type": "link out",
    "z": "a1e22fa468f03c15",
    "g": "f36ad9add0dea84a",
    "name": "home - linky - source",
    "mode": "link",
    "links": [
      "206c1fb4a48067df"
    ],
    "x": 1955,
    "y": 3060,
    "wires": []
  },
  {
    "id": "4f797f5a02d9c87b",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "f36ad9add0dea84a",
    "name": "power",
    "rules": [
      {
        "t": "set",
        "p": "field",
        "pt": "msg",
        "to": "power",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "payload",
        "pt": "msg",
        "to": "$number(msg.payload.PAPP.value)",
        "tot": "jsonata"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 1330,
    "y": 3120,
    "wires": [
      [
        "4587eb595b780266"
      ]
    ]
  },
  {
    "id": "14633267d792195b",
    "type": "delay",
    "z": "a1e22fa468f03c15",
    "g": "f36ad9add0dea84a",
    "name": "limit 1 msg / m",
    "pauseType": "rate",
    "timeout": "1",
    "timeoutUnits": "seconds",
    "rate": "1",
    "nbRateUnits": "1",
    "rateUnits": "minute",
    "randomFirst": "1",
    "randomLast": "5",
    "randomUnits": "seconds",
    "drop": true,
    "allowrate": false,
    "outputs": 1,
    "x": 1620,
    "y": 3240,
    "wires": [
      [
        "cb99733f4cbf651a"
      ]
    ]
  },
  {
    "id": "0883ad76e9a7a5db",
    "type": "delay",
    "z": "a1e22fa468f03c15",
    "g": "f36ad9add0dea84a",
    "name": "limit 1 msg / m",
    "pauseType": "rate",
    "timeout": "1",
    "timeoutUnits": "seconds",
    "rate": "1",
    "nbRateUnits": "1",
    "rateUnits": "minute",
    "randomFirst": "1",
    "randomLast": "5",
    "randomUnits": "seconds",
    "drop": true,
    "allowrate": false,
    "outputs": 1,
    "x": 1620,
    "y": 3300,
    "wires": [
      [
        "cb99733f4cbf651a"
      ]
    ]
  },
  {
    "id": "a475141eb65765c3",
    "type": "delay",
    "z": "a1e22fa468f03c15",
    "g": "f36ad9add0dea84a",
    "name": "limit 1 msg / m",
    "pauseType": "rate",
    "timeout": "1",
    "timeoutUnits": "seconds",
    "rate": "1",
    "nbRateUnits": "1",
    "rateUnits": "minute",
    "randomFirst": "1",
    "randomLast": "5",
    "randomUnits": "seconds",
    "drop": true,
    "allowrate": false,
    "outputs": 1,
    "x": 1620,
    "y": 3360,
    "wires": [
      [
        "cb99733f4cbf651a"
      ]
    ]
  },
  {
    "id": "d90ff6b37443ec5f",
    "type": "delay",
    "z": "a1e22fa468f03c15",
    "g": "f36ad9add0dea84a",
    "name": "limit 1 msg / m",
    "pauseType": "rate",
    "timeout": "1",
    "timeoutUnits": "seconds",
    "rate": "1",
    "nbRateUnits": "1",
    "rateUnits": "minute",
    "randomFirst": "1",
    "randomLast": "5",
    "randomUnits": "seconds",
    "drop": true,
    "allowrate": false,
    "outputs": 1,
    "x": 1620,
    "y": 3180,
    "wires": [
      [
        "cb99733f4cbf651a"
      ]
    ]
  },
  {
    "id": "8e9b1543c286b201",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "f36ad9add0dea84a",
    "name": "tariff",
    "rules": [
      {
        "t": "set",
        "p": "field",
        "pt": "msg",
        "to": "tariff",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "payload",
        "pt": "msg",
        "to": "payload.PTEC.value",
        "tot": "msg"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 1330,
    "y": 3180,
    "wires": [
      [
        "d90ff6b37443ec5f"
      ]
    ]
  },
  {
    "id": "6d6ed9fb73d6e770",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "f36ad9add0dea84a",
    "name": "peak hours counter",
    "rules": [
      {
        "t": "set",
        "p": "field",
        "pt": "msg",
        "to": "peak hours counter",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "payload",
        "pt": "msg",
        "to": "$number(msg.payload.HCHP.value)",
        "tot": "jsonata"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 1370,
    "y": 3240,
    "wires": [
      [
        "14633267d792195b"
      ]
    ]
  },
  {
    "id": "d8cbcb0859722902",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "f36ad9add0dea84a",
    "name": "off-peak hours counter",
    "rules": [
      {
        "t": "set",
        "p": "field",
        "pt": "msg",
        "to": "off-peak hours counter",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "payload",
        "pt": "msg",
        "to": "$number(msg.payload.HCHC.value)",
        "tot": "jsonata"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 1380,
    "y": 3300,
    "wires": [
      [
        "0883ad76e9a7a5db"
      ]
    ]
  },
  {
    "id": "0dac7d543eb0f2f6",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "f36ad9add0dea84a",
    "name": "total hours counter",
    "rules": [
      {
        "t": "set",
        "p": "field",
        "pt": "msg",
        "to": "total hours counter",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "payload",
        "pt": "msg",
        "to": "$number(msg.payload.HCHC.value) + $number(msg.payload.HCHP.value)",
        "tot": "jsonata"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 1370,
    "y": 3360,
    "wires": [
      [
        "a475141eb65765c3"
      ]
    ]
  },
  {
    "id": "4587eb595b780266",
    "type": "rbe",
    "z": "a1e22fa468f03c15",
    "g": "f36ad9add0dea84a",
    "name": "only changes",
    "func": "rbe",
    "gap": "",
    "start": "",
    "inout": "out",
    "septopics": true,
    "property": "payload",
    "topi": "topic",
    "x": 1530,
    "y": 3060,
    "wires": [
      [
        "cb99733f4cbf651a"
      ]
    ]
  },
  {
    "id": "1f088dee7d4ae695",
    "type": "link out",
    "z": "a1e22fa468f03c15",
    "g": "f36ad9add0dea84a",
    "name": "home - linky - source passthrough",
    "mode": "link",
    "links": [
      "1ef3db77515c5330"
    ],
    "x": 1295,
    "y": 3420,
    "wires": []
  },
  {
    "id": "43c18e1bfd41d830",
    "type": "switch",
    "z": "a1e22fa468f03c15",
    "g": "f36ad9add0dea84a",
    "name": "check topic",
    "property": "topic",
    "propertyType": "msg",
    "rules": [
      {
        "t": "regex",
        "v": "msg.linky_id&'$'",
        "vt": "jsonata",
        "case": false
      }
    ],
    "checkall": "false",
    "repair": false,
    "outputs": 1,
    "x": 1150,
    "y": 3060,
    "wires": [
      [
        "1f088dee7d4ae695",
        "0dac7d543eb0f2f6",
        "d8cbcb0859722902",
        "6d6ed9fb73d6e770",
        "8e9b1543c286b201",
        "4f797f5a02d9c87b",
        "9a7347381e1e503b"
      ]
    ]
  },
  {
    "id": "acc79920bf40652d",
    "type": "link in",
    "z": "a1e22fa468f03c15",
    "g": "f36ad9add0dea84a",
    "name": "home - linky - source",
    "links": [
      "b491f7eb02575108"
    ],
    "x": 795,
    "y": 3060,
    "wires": [
      [
        "8632c99c540f117b"
      ]
    ]
  },
  {
    "id": "8632c99c540f117b",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "f36ad9add0dea84a",
    "name": "get linky id",
    "rules": [
      {
        "t": "set",
        "p": "linky_id",
        "pt": "msg",
        "to": "metrics.linky.config[\"linky id\"]",
        "tot": "global"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 950,
    "y": 3060,
    "wires": [
      [
        "43c18e1bfd41d830"
      ]
    ]
  },
  {
    "id": "0e2bb377d8a36c19",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "4cb9d5d99960728b",
    "name": "linky / current / number / 0",
    "rules": [
      {
        "t": "set",
        "p": "measurement",
        "pt": "msg",
        "to": "linky",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "field",
        "pt": "msg",
        "to": "current",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "format",
        "pt": "msg",
        "to": "number",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "default",
        "pt": "msg",
        "to": "0",
        "tot": "num"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 330,
    "y": 3060,
    "wires": [
      [
        "c726ae1ce799b0e5"
      ]
    ]
  },
  {
    "id": "c726ae1ce799b0e5",
    "type": "link out",
    "z": "a1e22fa468f03c15",
    "g": "4cb9d5d99960728b",
    "name": "home - linky - device",
    "mode": "link",
    "links": [
      "bfa594bf1f876c92"
    ],
    "x": 615,
    "y": 3060,
    "wires": []
  },
  {
    "id": "5efcbb548a75c53a",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "4cb9d5d99960728b",
    "name": "linky / power / number / 0",
    "rules": [
      {
        "t": "set",
        "p": "measurement",
        "pt": "msg",
        "to": "linky",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "field",
        "pt": "msg",
        "to": "power",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "format",
        "pt": "msg",
        "to": "number",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "default",
        "pt": "msg",
        "to": "0",
        "tot": "num"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 330,
    "y": 3120,
    "wires": [
      [
        "c726ae1ce799b0e5"
      ]
    ]
  },
  {
    "id": "6bb288d4243c8284",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "4cb9d5d99960728b",
    "name": "linky / off-peak hours counter / number / 0",
    "rules": [
      {
        "t": "set",
        "p": "measurement",
        "pt": "msg",
        "to": "linky",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "field",
        "pt": "msg",
        "to": "off-peak hours counter",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "format",
        "pt": "msg",
        "to": "number",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "default",
        "pt": "msg",
        "to": "0",
        "tot": "num"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 380,
    "y": 3300,
    "wires": [
      [
        "c726ae1ce799b0e5"
      ]
    ]
  },
  {
    "id": "614269acaeaa7867",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "4cb9d5d99960728b",
    "name": "linky / peak hours counter / number / 0",
    "rules": [
      {
        "t": "set",
        "p": "measurement",
        "pt": "msg",
        "to": "linky",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "field",
        "pt": "msg",
        "to": "peak hours counter",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "format",
        "pt": "msg",
        "to": "number",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "default",
        "pt": "msg",
        "to": "0",
        "tot": "num"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 370,
    "y": 3240,
    "wires": [
      [
        "c726ae1ce799b0e5"
      ]
    ]
  },
  {
    "id": "627ed76685724eb3",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "4cb9d5d99960728b",
    "name": "linky / total hours counter / number / 0",
    "rules": [
      {
        "t": "set",
        "p": "measurement",
        "pt": "msg",
        "to": "linky",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "field",
        "pt": "msg",
        "to": "total hours counter",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "format",
        "pt": "msg",
        "to": "number",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "default",
        "pt": "msg",
        "to": "0",
        "tot": "num"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 370,
    "y": 3360,
    "wires": [
      [
        "c726ae1ce799b0e5"
      ]
    ]
  },
  {
    "id": "f87443fe4174e06e",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "4cb9d5d99960728b",
    "name": "linky / tariff / text / HP",
    "rules": [
      {
        "t": "set",
        "p": "measurement",
        "pt": "msg",
        "to": "linky",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "field",
        "pt": "msg",
        "to": "tariff",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "format",
        "pt": "msg",
        "to": "text",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "default",
        "pt": "msg",
        "to": "HP",
        "tot": "str"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 320,
    "y": 3180,
    "wires": [
      [
        "c726ae1ce799b0e5"
      ]
    ]
  },
  {
    "id": "ab6d3d1be0d9ea74",
    "type": "link in",
    "z": "a1e22fa468f03c15",
    "g": "4cb9d5d99960728b",
    "name": "home - linky - device",
    "links": [
      "fb0afb89fb191395"
    ],
    "x": 135,
    "y": 3060,
    "wires": [
      [
        "0e2bb377d8a36c19",
        "5efcbb548a75c53a",
        "f87443fe4174e06e",
        "614269acaeaa7867",
        "6bb288d4243c8284",
        "627ed76685724eb3"
      ]
    ]
  },
  {
    "id": "be031b830d435b36",
    "type": "link in",
    "z": "a1e22fa468f03c15",
    "g": "afbdaa08d5344ac6",
    "name": "home - linky - ui - metric",
    "links": [
      "031a6afd8300356a"
    ],
    "x": 2215,
    "y": 3060,
    "wires": [
      [
        "14d401bc50aa536b"
      ]
    ]
  },
  {
    "id": "b0f5b19866b880c9",
    "type": "switch",
    "z": "a1e22fa468f03c15",
    "g": "afbdaa08d5344ac6",
    "name": "home/linky/xxx",
    "property": "path",
    "propertyType": "msg",
    "rules": [
      {
        "t": "eq",
        "v": "msg.bucket & '/linky/current'",
        "vt": "jsonata"
      },
      {
        "t": "eq",
        "v": "msg.bucket & '/linky/power'",
        "vt": "jsonata"
      },
      {
        "t": "eq",
        "v": "msg.bucket & '/linky/tariff'",
        "vt": "jsonata"
      }
    ],
    "checkall": "false",
    "repair": false,
    "outputs": 3,
    "x": 3010,
    "y": 3120,
    "wires": [
      [
        "c3473ac9ec464425"
      ],
      [
        "16de923274d0e608"
      ],
      [
        "9188974904e49bd8"
      ]
    ]
  },
  {
    "id": "14d401bc50aa536b",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "afbdaa08d5344ac6",
    "name": "set bucket",
    "rules": [
      {
        "t": "set",
        "p": "bucket",
        "pt": "msg",
        "to": "home",
        "tot": "str"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 2790,
    "y": 3060,
    "wires": [
      [
        "b0f5b19866b880c9"
      ]
    ]
  },
  {
    "id": "9188974904e49bd8",
    "type": "function",
    "z": "a1e22fa468f03c15",
    "g": "afbdaa08d5344ac6",
    "name": "HP/HC",
    "func": "if (msg.payload=='HP'){\n    msg.payload='Heures pleines';\n} else {\n    msg.payload='Heures creuses';\n}\nreturn msg;",
    "outputs": 1,
    "timeout": "",
    "noerr": 0,
    "initialize": "",
    "finalize": "",
    "libs": [],
    "x": 3200,
    "y": 3180,
    "wires": [
      [
        "b061fecd100938a0"
      ]
    ]
  },
  {
    "id": "35ccd1812072ccad",
    "type": "ui-text",
    "z": "a1e22fa468f03c15",
    "g": "afbdaa08d5344ac6",
    "group": "241fa70e798648e8",
    "order": 2,
    "width": "1",
    "height": "1",
    "name": "current",
    "label": "",
    "format": "{{msg.payload}}",
    "layout": "row-spread",
    "style": false,
    "font": "",
    "fontSize": 16,
    "color": "#717171",
    "className": "",
    "x": 3380,
    "y": 3120,
    "wires": []
  },
  {
    "id": "c3473ac9ec464425",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "afbdaa08d5344ac6",
    "name": "payload",
    "rules": [
      {
        "t": "set",
        "p": "payload",
        "pt": "msg",
        "to": "'('&msg.payload&'A)'",
        "tot": "jsonata"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 3200,
    "y": 3120,
    "wires": [
      [
        "35ccd1812072ccad"
      ]
    ]
  },
  {
    "id": "16de923274d0e608",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "afbdaa08d5344ac6",
    "name": "payload",
    "rules": [
      {
        "t": "set",
        "p": "payload",
        "pt": "msg",
        "to": "msg.payload&'W'",
        "tot": "jsonata"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 3200,
    "y": 3060,
    "wires": [
      [
        "b5e38130b6f4407c"
      ]
    ]
  },
  {
    "id": "b5e38130b6f4407c",
    "type": "ui-text",
    "z": "a1e22fa468f03c15",
    "g": "afbdaa08d5344ac6",
    "group": "241fa70e798648e8",
    "order": 1,
    "width": "5",
    "height": "1",
    "name": "power",
    "label": "Puissance linky",
    "format": "{{msg.payload}}",
    "layout": "row-spread",
    "style": false,
    "font": "",
    "fontSize": 16,
    "color": "#717171",
    "className": "",
    "x": 3370,
    "y": 3060,
    "wires": []
  },
  {
    "id": "b061fecd100938a0",
    "type": "ui-text",
    "z": "a1e22fa468f03c15",
    "g": "afbdaa08d5344ac6",
    "group": "241fa70e798648e8",
    "order": 4,
    "width": "6",
    "height": "1",
    "name": "tariff",
    "label": "Tarif linky",
    "format": "{{msg.payload}}",
    "layout": "row-spread",
    "style": false,
    "font": "",
    "fontSize": 16,
    "color": "#717171",
    "className": "",
    "x": 3370,
    "y": 3180,
    "wires": []
  },
  {
    "id": "a5bcb16d923c6f77",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "afbdaa08d5344ac6",
    "name": "set metric",
    "rules": [
      {
        "t": "set",
        "p": "bucket",
        "pt": "msg",
        "to": "home",
        "tot": "str"
      },
      {
        "t": "set",
        "p": "path",
        "pt": "msg",
        "to": "msg.bucket & '/linky/' & msg.field",
        "tot": "jsonata"
      },
      {
        "t": "set",
        "p": "payload",
        "pt": "msg",
        "to": "metrics[msg.bucket]linky[msg.field]",
        "tot": "global"
      },
      {
        "t": "delete",
        "p": "parts",
        "pt": "msg"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 2800,
    "y": 3120,
    "wires": [
      [
        "b0f5b19866b880c9"
      ]
    ]
  },
  {
    "id": "5d277429bd835728",
    "type": "link in",
    "z": "a1e22fa468f03c15",
    "g": "afbdaa08d5344ac6",
    "name": "home - linky - ui - load",
    "links": [
      "25445f5a9b787a0a"
    ],
    "x": 2215,
    "y": 3120,
    "wires": [
      [
        "942e30b09b200628"
      ]
    ]
  },
  {
    "id": "942e30b09b200628",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "afbdaa08d5344ac6",
    "name": "from global",
    "rules": [
      {
        "t": "set",
        "p": "payload",
        "pt": "msg",
        "to": "metrics.home.linky",
        "tot": "global"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 2370,
    "y": 3120,
    "wires": [
      [
        "5d9abb5beb266ad0"
      ]
    ]
  },
  {
    "id": "5d9abb5beb266ad0",
    "type": "split",
    "z": "a1e22fa468f03c15",
    "g": "afbdaa08d5344ac6",
    "name": "split measurement",
    "splt": "\\n",
    "spltType": "str",
    "arraySplt": 1,
    "arraySpltType": "len",
    "stream": false,
    "addname": "field",
    "x": 2590,
    "y": 3120,
    "wires": [
      [
        "a5bcb16d923c6f77"
      ]
    ]
  },
  {
    "id": "b9abd7ec5b21a355",
    "type": "ui-text",
    "z": "a1e22fa468f03c15",
    "g": "afbdaa08d5344ac6",
    "group": "241fa70e798648e8",
    "order": 5,
    "width": "6",
    "height": "1",
    "name": "conso_total_today",
    "label": "Consommation linky ajourdh'ui",
    "format": "{{msg.payload}}",
    "layout": "row-spread",
    "style": false,
    "font": "",
    "fontSize": 16,
    "color": "#717171",
    "className": "",
    "x": 3410,
    "y": 3240,
    "wires": []
  },
  {
    "id": "6c30e4c5efef2336",
    "type": "ui-text",
    "z": "a1e22fa468f03c15",
    "g": "afbdaa08d5344ac6",
    "group": "241fa70e798648e8",
    "order": 6,
    "width": "6",
    "height": "1",
    "name": "conso_total_yesturday",
    "label": "Consommation linky hier",
    "format": "{{msg.payload}}",
    "layout": "row-spread",
    "style": false,
    "font": "",
    "fontSize": 16,
    "color": "#717171",
    "className": "",
    "x": 3420,
    "y": 3300,
    "wires": []
  },
  {
    "id": "04c4726b012f7cde",
    "type": "influxdb in",
    "z": "a1e22fa468f03c15",
    "g": "afbdaa08d5344ac6",
    "influxdb": "e408b55d1dc6870d",
    "name": "",
    "query": "import \"date\"\nfrom(bucket: \"linky\")\n  |> range(start: date.truncate(t:now(),unit:1d), stop: date.truncate(t:1d,unit:1d))\n  |> filter(fn: (r) =>\n    r._field == \"conso_total_day\"\n  )\n  |> aggregateWindow(every: 24h, fn: max)",
    "rawOutput": false,
    "precision": "",
    "retentionPolicy": "",
    "org": "iotredloop",
    "x": 2380,
    "y": 3240,
    "wires": [
      [
        "8e4e7eeb105a289a"
      ]
    ]
  },
  {
    "id": "b8039538d3ab41e7",
    "type": "link in",
    "z": "a1e22fa468f03c15",
    "g": "afbdaa08d5344ac6",
    "name": "home - linky - ui - cron",
    "links": [
      "004bb30c27c94fb4"
    ],
    "x": 2215,
    "y": 3240,
    "wires": [
      [
        "04c4726b012f7cde",
        "a5b6191ffdceb78b"
      ]
    ]
  },
  {
    "id": "a5b6191ffdceb78b",
    "type": "influxdb in",
    "z": "a1e22fa468f03c15",
    "g": "afbdaa08d5344ac6",
    "influxdb": "e408b55d1dc6870d",
    "name": "",
    "query": "import \"date\"\nfrom(bucket: \"linky\")\n  |> range(start: date.truncate(t:-1d,unit:1d), stop: date.truncate(t:0d,unit:1d))\n  |> filter(fn: (r) =>\n    r._field == \"conso_total_day\"\n  )\n  |> aggregateWindow(every: 24h, fn: max)",
    "rawOutput": false,
    "precision": "",
    "retentionPolicy": "",
    "org": "iotredloop",
    "x": 2380,
    "y": 3300,
    "wires": [
      [
        "426522c68084a014"
      ]
    ]
  },
  {
    "id": "9e040dfa6ba0238f",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "afbdaa08d5344ac6",
    "name": "format",
    "rules": [
      {
        "t": "set",
        "p": "payload",
        "pt": "msg",
        "to": "payload.0['_value']",
        "tot": "msg"
      },
      {
        "t": "set",
        "p": "payload",
        "pt": "msg",
        "to": "$round($number(msg.payload)/1000, 1)&'kWh'",
        "tot": "jsonata"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 2770,
    "y": 3240,
    "wires": [
      [
        "b9abd7ec5b21a355"
      ]
    ]
  },
  {
    "id": "8883fe1a066abc69",
    "type": "change",
    "z": "a1e22fa468f03c15",
    "g": "afbdaa08d5344ac6",
    "name": "format",
    "rules": [
      {
        "t": "set",
        "p": "payload",
        "pt": "msg",
        "to": "payload.0['_value']",
        "tot": "msg"
      },
      {
        "t": "set",
        "p": "payload",
        "pt": "msg",
        "to": "$round(msg.payload/1000, 1)&'kWh'",
        "tot": "jsonata"
      }
    ],
    "action": "",
    "property": "",
    "from": "",
    "to": "",
    "reg": false,
    "x": 2770,
    "y": 3300,
    "wires": [
      [
        "6c30e4c5efef2336"
      ]
    ]
  },
  {
    "id": "8e4e7eeb105a289a",
    "type": "switch",
    "z": "a1e22fa468f03c15",
    "g": "afbdaa08d5344ac6",
    "name": "has values",
    "property": "payload",
    "propertyType": "msg",
    "rules": [
      {
        "t": "nempty"
      }
    ],
    "checkall": "false",
    "repair": false,
    "outputs": 1,
    "x": 2590,
    "y": 3240,
    "wires": [
      [
        "9e040dfa6ba0238f"
      ]
    ]
  },
  {
    "id": "426522c68084a014",
    "type": "switch",
    "z": "a1e22fa468f03c15",
    "g": "afbdaa08d5344ac6",
    "name": "has values",
    "property": "payload",
    "propertyType": "msg",
    "rules": [
      {
        "t": "nempty"
      }
    ],
    "checkall": "false",
    "repair": false,
    "outputs": 1,
    "x": 2590,
    "y": 3300,
    "wires": [
      [
        "8883fe1a066abc69"
      ]
    ]
  },
  {
    "id": "06b7f0862564450a",
    "type": "switch",
    "z": "a1e22fa468f03c15",
    "g": "f65dfdda10900ffc",
    "name": "inject",
    "property": "payload",
    "propertyType": "msg",
    "rules": [
      {
        "t": "eq",
        "v": "0",
        "vt": "num"
      },
      {
        "t": "else"
      }
    ],
    "checkall": "false",
    "repair": false,
    "outputs": 2,
    "x": 770,
    "y": 900,
    "wires": [
      [
        "80713009a92b1fb1"
      ],
      [
        "df89dd445c170c34"
      ]
    ]
  },
  {
    "id": "9a0a261261c064da",
    "type": "switch",
    "z": "a1e22fa468f03c15",
    "g": "543a74289e049295",
    "name": "new",
    "property": "payload.new",
    "propertyType": "msg",
    "rules": [
      {
        "t": "nempty"
      }
    ],
    "checkall": "false",
    "repair": false,
    "outputs": 1,
    "x": 950,
    "y": 1020,
    "wires": [
      [
        "ffd6cc9a833578f9"
      ]
    ]
  },
  {
    "id": "ffd6cc9a833578f9",
    "type": "switch",
    "z": "a1e22fa468f03c15",
    "g": "543a74289e049295",
    "name": "old",
    "property": "payload.old",
    "propertyType": "msg",
    "rules": [
      {
        "t": "nempty"
      }
    ],
    "checkall": "false",
    "repair": false,
    "outputs": 1,
    "x": 1110,
    "y": 1020,
    "wires": [
      [
        "af3687a9f899e8da"
      ]
    ]
  },
  {
    "id": "fd73f58e64fd7772",
    "type": "comment",
    "z": "a1e22fa468f03c15",
    "g": "543a74289e049295",
    "name": "",
    "info": "",
    "x": 790,
    "y": 1080,
    "wires": []
  }
]